<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聽歌學日文</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-hidden { display: none; }
        .active-tab { border-bottom: 4px solid #6366f1; color: #6366f1; font-weight: bold; }
        /* 讓換行符號正常顯示 */
        .content-display { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">
    <div class="max-w-2xl mx-auto bg-white min-h-screen shadow-md">
        <header class="bg-indigo-600 p-4 text-white sticky top-0 z-10 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold tracking-wider">聽歌學日文</h1>
            <input type="date" id="datePicker" class="text-black text-sm p-1 rounded border-none shadow-inner" onchange="loadLesson()">
        </header>

        <div id="videoContainer" class="bg-slate-900 aspect-video w-full flex items-center justify-center text-white text-sm overflow-hidden">
            <p id="videoPlaceholder" class="p-4 text-center text-gray-400">請在下方編輯區貼入 YouTube 連結後按儲存</p>
        </div>

        <details class="bg-indigo-50 p-4 border-b border-indigo-100" id="editDetails">
            <summary class="cursor-pointer text-sm font-bold text-indigo-700">✏️ 編輯/貼入今日課程 (點此展開)</summary>
            <div class="mt-3 space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">YouTube 網址</label>
                    <input type="text" id="ytInput" class="w-full p-2 border rounded text-sm" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">第一頁：全曲歌詞</label>
                    <textarea id="lyricsInput" class="w-full h-32 p-2 border rounded text-sm" placeholder="日中對照歌詞..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">第二頁：重點單字</label>
                    <textarea id="wordsInput" class="w-full h-32 p-2 border rounded text-sm" placeholder="單字、假名、中文..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">第三頁：文法解析</label>
                    <textarea id="grammarInput" class="w-full h-32 p-2 border rounded text-sm" placeholder="語法重點與例句..."></textarea>
                </div>
                <button onclick="saveLesson()" id="saveBtn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">儲存今日課程內容</button>
            </div>
        </details>

        <div class="flex border-b border-gray-200 sticky top-[60px] bg-white z-10 shadow-sm">
            <button onclick="switchTab(1)" id="tab1" class="flex-1 py-4 text-sm active-tab">歌詞對照</button>
            <button onclick="switchTab(2)" id="tab2" class="flex-1 py-4 text-sm text-gray-500 hover:bg-gray-50">重點單字</button>
            <button onclick="switchTab(3)" id="tab3" class="flex-1 py-4 text-sm text-gray-500 hover:bg-gray-50">文法例句</button>
        </div>

        <div class="p-6 min-h-[400px]">
            <div id="card1" class="card-content content-display text-gray-700 leading-relaxed"></div>
            <div id="card2" class="card-content card-hidden content-display text-gray-700 leading-relaxed"></div>
            <div id="card3" class="card-content card-hidden content-display text-gray-700 leading-relaxed"></div>
        </div>
    </div>

    <script>
        function switchTab(tabIndex) {
            for(let i=1; i<=3; i++) {
                document.getElementById('tab'+i).className = "flex-1 py-4 text-sm text-gray-500 hover:bg-gray-50";
                document.getElementById('card'+i).classList.add('card-hidden');
            }
            document.getElementById('tab'+tabIndex).className = "flex-1 py-4 text-sm active-tab";
            document.
getElementById('card'+tabIndex).classList.remove('card-hidden');
        }

        function getYoutubeID(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function saveLesson() {
            const date = document.getElementById('datePicker').value;
            if (!date) {
                alert("請先選擇日期！");
                return;
            }
            
            const btn = document.getElementById('saveBtn');
            const data = {
                yt: document.getElementById('ytInput').value.trim(),
                lyrics: document.getElementById('lyricsInput').value,
                words: document.getElementById('wordsInput').value,
                grammar: document.getElementById('grammarInput').value
            };
            
            try {
                localStorage.setItem('lesson-' + date, JSON.stringify(data));
                
                // 儲存成功動畫
                btn.innerText = "✅ 已成功儲存！";
                btn.classList.replace('bg-indigo-600', 'bg-green-500');
                
                setTimeout(() => {
                    btn.innerText = "儲存今日課程內容";
                    btn.classList.replace('bg-green-500', 'bg-indigo-600');
                    document.getElementById('editDetails').open = false; // 自動收起編輯區
                }, 1500);

                loadLesson();
            } catch (e) {
                alert("儲存失敗，可能是內容太多或瀏覽器限制：" + e);
            }
        }

        function loadLesson() {
            const date = document.getElementById('datePicker').value;
            const rawData = localStorage.getItem('lesson-' + date);
            
            if (rawData) {
                const data = JSON.parse(rawData);
                document.getElementById('ytInput').value = data.yt || "";
                document.getElementById('lyricsInput').value = data.lyrics || "";
                document.getElementById('wordsInput').value = data.words || "";
                document.getElementById('grammarInput').value = data.grammar || "";

                const ytID = getYoutubeID(data.yt);
                if (ytID) {
                    document.getElementById('videoContainer').innerHTML = <iframe class="w-full h-full" src="https://www.youtube.com/embed/${ytID}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>;
                } else {
                    document.getElementById('videoContainer').innerHTML = <p class="p-4 text-gray-400">影片連結無效或尚未設定</p>;
                }

                document.getElementById('card1').innerText = data.lyrics || "尚無歌詞內容";
                document.getElementById('card2').innerText = data.words || "尚無單字內容";
                document.getElementById('card3').innerText = data.grammar || "尚無文法內容";
            } else {
                // 清空預覽
                document.getElementById('videoContainer').innerHTML = <p class="p-4 text-gray-400 text-center">今天還沒有課程內容<br>請點下方編輯按鈕開始</p>;
                document.getElementById('card1').innerText = "請展開上方編輯區並貼入內容。";
                document.getElementById('card2').innerText = "";
                document.getElementById('card3').innerText = "";
                // 清空輸入框
                ["ytInput", "lyricsInput", "wordsInput", "grammarInput"].forEach(id => document.getElementById(id).value = "");
            }
        }

        // 預設今天日期
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            loadLesson();
        };
    </script>
</body>
</html>